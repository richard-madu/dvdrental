--We would like to know who were our top 10 paying customers, how many payments they made on a monthly basis during 2007, and what was the amount of the monthly payments
--create a temp table that queries the top 10 customers
With top10 as (SELECT
        c.customer_id, c.first_name||' '||c.last_name as full_name,
        sum(p.amount) total
    FROM
        customer c
        JOIN payment p ON c.customer_id = p.customer_id
    GROUP BY
        1,2
    ORDER BY
        3 DESC
    LIMIT 10
               
),

-- Create another temp table that queries the monthly payment of customers
monthly_customer_payment_by_month AS 
(
SELECT
  c.customer_id,
  date_trunc('month', p.payment_date) payment_month,
  SUM(p.amount) monthly_total,
  COUNT(payment_id) payment_count
FROM customer c
JOIN payment p
  ON c.customer_id = p.customer_id
WHERE date_part('year', p.payment_date) = 2007
GROUP BY 1,
         2
ORDER BY 1,
2
)
-- Join the two temp tables
SELECT
  full_name,
  payment_month,
  monthly_total,
  payment_count
FROM monthly_customer_payment_by_month
JOIN top10
  ON top10.customer_id = monthly_customer_payment_by_month.customer_id
ORDER BY full_name


