--We would like to know who were our top 10 paying customers, 
--how many payments they made on a monthly basis during 2007, and what was the amount of the monthly payments. 

--temp Table that queryies the names of the top 10 customer
WITH topPayingCustomers AS 
(SELECT
  (first_name || ' ' || last_name) as full_name,
  SUM(p.amount) AS total_payment
FROM customer c
JOIN payment p
  ON p.customer_id = c.customer_id
GROUP BY (first_name || ' ' || last_name)
ORDER BY 2 DESC
LIMIT 10
)
SELECT
	DATE_TRUNC('month', p.payment_date) AS pay_mon,  	first_name || ' ' || last_name AS fullname, 
	COUNT(p.amount) AS pay_countpermon,
	SUM(p.amount) AS pay_amount,
--use window function to get the leads and the lead diff	
	LEAD(SUM(p.amount)) OVER(PARTITION BY (first_name || ' ' 	|| last_name)) AS next_pay_amount, 
	(-SUM(p.amount)+LEAD(SUM(p.amount)) OVER(PARTITION BY 	(first_name || ' ' || last_name))) as difference
FROM
	customer c
JOIN
	payment p
ON
	p.customer_id = c.customer_id
AND 
	p.payment_date BETWEEN '2007-01-01' AND '2008-01-01'
-- filter to include only the top10 customers"
WHERE
	first_name || ' ' || last_name in (SELECT full_name FROM 	topPayingCustomers  )
GROUP BY
	fullname, pay_mon
ORDER BY
	fullname, pay_mon, pay_countpermon
